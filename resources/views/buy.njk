{% extends 'layouts/master.njk' %}

{% block title %}Buy | RangerSteve.io{% endblock %}

{% block content %}
<section class="container pv8 ph8 text-center main-section" id="store-container" v-cloak>
  {% if gameDiscount > 0 %}
    <div class="well mb0 bra0 text-center pr5 pl5 mb0 bra0 pv5 tcw bg-lily-meadow" v-if="!isPremium">
      <h3 class="mt4 mb1 fwbold">Pre-Order Now, 40% Discount!</h3>
      <p class="ft8 lh13 mb4">
        This game will always be free to play, but <strong>early purchases help us add features</strong> faster. <br />
        Premium features are <strong>currently in development</strong> and as they are released you will <strong>automatically have access to them</strong>.
      </p>
    </div>
  {% endif %}

  <div class="well mb0 bra0">
    <form class="mt5 mb5 db mauto" action="/charge" method="POST" style="width: 400px;" v-if="!isPremium">
      <input type="hidden" v-bind:value="uid" name="uid" />
      <stripe-checkout
        form-id="buy-button"
        stripe-key="{{ stripePublicKey }}"
        stripe-name="RangerSteve.io"
        stripe-description="Premium RangerSteve.io"
        stripe-amount="{{ gameTotalPrice * 100 }}"
        stripe-image="/images/tile-logo.png"
      >
        <button class="btn btn-success uppercase ph5 mb4 ft15">
          Buy Premium <br />
          <span class="ft10">One Time Purchase For ${{ gameTotalPrice }}</span>
        </button>
      </stripe-checkout>
    </form>

    <div class="row mb6 mt5" v-if="isPremium">
      <div class="col-sm-12">
        <h1 class="ff-bangers tcw ft35 mb0 mt0">Congratulations!</h1>
        <h2 class="tcw mt0">You have Premium access to all of the features in RangerSteve.io!</h2>
      </div>
    </div>

    <div class="row no-pointer-events mb5">
      <div class="col-xs-4">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>7+ New Characters</span>
          <img src="/images/characters/CommandoMike.png" />
        </a>
      </div>
      <div class="col-xs-4">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>4+ New Guns</span>
          <img src="/images/store/flamethrower.png" style="max-height: 166px;" />
        </a>
      </div>
      <div class="col-xs-4">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>In Game Premium Status</span>
          <img src="/images/ui/dark-sword.png" style="max-height: 166px;" />
        </a>
      </div>
    </div>
  </div>

  <div class="well mb0 bra0 bg-lily-meadow">
    <h2 class="ff-bangers tcw text-stroke ft25 mb6 mt3">7+ Characters</h2>
    <div class="row no-pointer-events">
      <div class="col-xs-3">
        <a class="gold-button btn btn-default" href="/store">
          <span>Commando Mike</span>
          <img src="/images/characters/CommandoMike.png" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default" href="/store">
          <span>GI John</span>
          <img src="/images/characters/GIJohn.png" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>Terrorist Jack</span>
          <img src="/images/characters/TerroristJim.png" height="166" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default" href="/store">
          <span>Real Estate Rob</span>
          <img src="/images/characters/RealEstateRob.png" height="166" />
        </a>
      </div>
    </div>
    <div class="row no-pointer-events mb5">
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>Secret Agent Sam</span>
          <img src="/images/characters/KGBViktor.png" width="125" height="166" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>Scuba Dave</span>
          <img src="/images/characters/Scooba.png" width="125" height="166" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>Redneck Jim</span>
          <img src="/images/characters/RedneckJim.png" width="120" height="166" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>More to come...</span>
          <img src="/images/characters/Placeholder.png" width="100" height="166" />
        </a>
      </div>
    </div>
  </div>

  <div class="well mb0 bra0">
    <h2 class="ff-bangers tcw text-stroke ft25 mb0 mt3">4+ Guns</h2>
    <p class="ft8 mb4 tcw">
      Art is coming soon!
    </p>
    <div class="row no-pointer-events mb5">
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0 text-center" href="/store">
          <span>Flamethrower</span>
          <img src="/images/store/flamethrower.png" style="max-width: 170px;" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>Ricochet Laser Rifle</span>
          <img src="/images/store/flamethrower.png" style="max-width: 170px;" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>Grenade Launcher</span>
          <img src="/images/store/flamethrower.png" style="max-width: 170px;" />
        </a>
      </div>
      <div class="col-xs-3">
        <a class="gold-button btn btn-default mb0" href="/store">
          <span>Needler</span>
          <img src="/images/store/flamethrower.png" style="max-width: 170px;" />
        </a>
      </div>
    </div>

    <form class="mt7 db mauto" action="/charge" method="POST" style="width: 400px;" v-if="!isPremium">
      <input type="hidden" v-bind:value="uid" name="uid" />
      <stripe-checkout
        form-id="buy-button"
        stripe-key="{{ stripePublicKey }}"
        stripe-name="RangerSteve.io"
        stripe-description="Premium RangerSteve.io"
        stripe-amount="{{ gameTotalPrice * 100 }}"
        stripe-image="/images/tile-logo.png"
      >
        <button class="btn btn-success uppercase ph5 mb4 ft15">
          Buy Premium <br />
          <span class="ft10">One Time Purchase For ${{ gameTotalPrice }}</span>
        </button>
      </stripe-checkout>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/merge@1.2.0"></script>
<script src="https://js.stripe.com/v2/"></script>
<script src="/js/stripe-checkout.js"></script>
<script>
  Stripe.setPublishableKey('{{ stripePublicKey }}')

  var gamePrice = {{ gamePrice }}
  var gameDiscount = {{ gameDiscount }}
  var isDiscount = {{ gameDiscount }} > 0

  new Vue({
    el: '#store-container',
    delimiters: ['${', '}'],
    data: {
      accountSuccessMessage: null,
      accountErrorMessage: null,
      auth: null,
      user: null,
      transactions: null,
      uid: null,
      gamePrice: gamePrice,
      gameDiscount: gameDiscount,
      isDiscount: isDiscount,
    },
    filters: {
      currency: function (value) {
        return '$' + parseFloat(value).toFixed(2)
      }
    },
    computed: {
      isPremium: function () {
        var self = this
        console.log(this.transactions)
        if (!this.transactions) return false

        var premiumTransactions = Object.keys(this.transactions)
          .filter(function (key) {
            return self.transactions[key].type === 'premium'
          })

        return premiumTransactions.length > 0
      }
    },
    beforeMount: function() {
      this.checkAuthStatus()
    },
    methods: {
      checkAuthStatus: function () {
        var self = this
        // Check if the user is signed in
        firebase.auth().onAuthStateChanged(function(auth) {
          if (!auth) return
          self.auth = auth
          self.uid = auth.uid
          self.fetchUser()
          self.fetchUserTransactions()
        })
      },
      fetchUserTransactions: function() {
        var self = this
        firebase.database()
          .ref('user_transactions/' + self.auth.uid)
          .once('value', function(snapshot) {
            self.transactions = snapshot.val()
            self.$forceUpdate()
          })
      },
      fetchUser: function () {
        var self = this
        firebase.database()
          .ref('users/' + self.auth.uid)
          .once('value', function(snapshot) {
            self.user = snapshot.val()
          })
      }
    }
  })
</script>
{% endblock %}
