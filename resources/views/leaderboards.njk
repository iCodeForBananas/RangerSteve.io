{% extends 'master.njk' %}

{% block title %}Leaderboards | RangerSteve.io{% endblock %}

{% block content %}
<span id="beta-label">Beta</span>

<section class="main-section" id="leaderboards-container" v-cloak>
  <div class="text-center">
    <span class="main-header">
      Leaderboards
    </span>
  </div>

  <div class="container">
    <div class="col-md-10 col-md-offset-1">
      <div class="well">
        <div class="row mb3">
          <div class="col-xs-6">
            <a class="btn btn-primary btn-lg btn-block" href="/">Back to Menu</a>
          </div>
          <div class="col-xs-6">
            <a class="btn btn-success btn-lg btn-block" href="/game">Play Now</a>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-middle table-hover tcw mb0">
            <thead>
              <tr>
                <th>Name</th>
                <th class="pointer" v-on:click="setSortColumn('score')">Score <span v-if="sortColumn === 'score'">▼</span></th>
                <th class="pointer" v-on:click="setSortColumn('kdr')">KDR <span v-if="sortColumn === 'kdr'">▼</span></th>
                <th class="pointer" v-on:click="setSortColumn('killsPerMinute')">Kills / Min <span v-if="sortColumn === 'killsPerMinute'">▼</span></th>
                <th class="pointer" v-on:click="setSortColumn('scorePerMinute')">Score / Min <span v-if="sortColumn === 'scorePerMinute'">▼</span></th>
                <th class="pointer" v-on:click="setSortColumn('winPercentage')">Win Percentage <span v-if="sortColumn === 'winPercentage'">▼</span></th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="playerScore in playerScores" class="pointer" v-on:click="openBattleStats(playerScore.name)">
                <td class="fwbold">${ playerScore.name }</td>
                <td>${ playerScore.score }</td>
                <td>${ playerScore.kdr }</td>
                <td>${ playerScore.killsPerMinute }</td>
                <td>${ playerScore.scorePerMinute }</td>
                <td>${ playerScore.winPercentage }%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  new Vue({
    el: '#leaderboards-container',
    delimiters: ['${', '}'],
    data: {
      leaderboards: {},
      usernameLookup: {},
      playerScores: {},
      sortColumn: 'score'
    },
    beforeMount: function() {
      this.fetchLeaderboards()
    },
    methods: {
      setSortColumn: function (column) {
        this.sortColumn = column
        this.fetchLeaderboards()
      },
      openBattleStats: function (playerName) {
        window.location = '/battle-stats/' + playerName
      },
      fetchLeaderboards: function () {
        var self = this
        var ref = firebase.database()
          .ref('leaderboards')
          .once('value', function(snapshot) {
            self.leaderboards = snapshot.val()
            self.fetchUsernameLookup()
          })
      },
      fetchUsernameLookup: function () {
        var self = this
        var ref = firebase.database()
          .ref('username_lookup')
          .once('value', function(snapshot) {
            self.usernameLookup = snapshot.val()
            self.renderLeaderboards()
          })
      },
      renderLeaderboards: function () {
        var self = this
        if (! this.leaderboards) return

        // Flip the object of uid: username -> username: uid
        var newUsernameLookup = {}
        Object.keys(this.usernameLookup)
          .forEach(function (username) {
            var playerId = self.usernameLookup[username]
            newUsernameLookup[playerId] = username
          })

        // Construct a new array of player objects
        // containing their name and leaderboard
        // record stats
        this.playerScores = Object.keys(this.leaderboards)
          .map(function (id) {
            var newPlayerObj = self.leaderboards[id]
            newPlayerObj.name = newUsernameLookup[id]
            return self.leaderboards[id]
          })

        // Calculate special stats for each player
        this.playerScores.forEach(function (playerScore) {
          // Calculate kill death ratio
          playerScore.kdr = playerScore.deaths > 0
            ? (playerScore.kills / playerScore.deaths).toFixed(2)
            : playerScore.kills

          // Calculate kills per minute
          var minutesInRound = playerScore.secondsInRound / 60
          playerScore.killsPerMinute = minutesInRound > 0 ?
            (playerScore.kills / minutesInRound).toFixed(1)
            : 0

          // Calculate score per minute
          playerScore.scorePerMinute = minutesInRound > 0
            ? (playerScore.score / minutesInRound).toFixed(1)
            : 0

          // Caluclate win percentage
          var roundsWon = _.get(playerScore, 'roundsWon', 0)
          var roundsLost = _.get(playerScore, 'roundsLost', 0)
          var totalRounds = roundsWon + roundsLost
          playerScore.winPercentage = totalRounds > 0
            ? (roundsWon / (roundsWon + roundsLost) * 100).toFixed(0)
            : 0
        })

        this.playerScores = this.playerScores.sort(function (a, b) {
          return  b[self.sortColumn] - a[self.sortColumn]
        })
      }
    }
  })
</script>
{% endblock %}
